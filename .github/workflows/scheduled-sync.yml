name: Scheduled Video Source Sync

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡ŒåŒæ­¥
    - cron: '0 3 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'

jobs:
  sync:
    name: Sync Video Sources
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate runtime config
        run: pnpm gen:runtime

      - name: Run video source sync
        id: sync
        run: |
          echo "Starting video source synchronization..."
          pnpm tsx src/sync/orchestrator.ts --log > sync-output.log 2>&1 || true
          echo "Sync completed"

          # æå–ç»Ÿè®¡ä¿¡æ¯
          if [ -f sources.json ]; then
            total_sources=$(cat sources.json | jq '. | length' || echo "0")
            healthy_sources=$(cat sources.json | jq '[.[] | select(.active == true)] | length' || echo "0")
            echo "total=$total_sources" >> $GITHUB_OUTPUT
            echo "healthy=$healthy_sources" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_ENV: production

      - name: Upload sync artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sync-results
          path: |
            sources.json
            sync-output.log
          retention-days: 7

      - name: Create sync report
        id: report
        if: always()
        run: |
          # ç”ŸæˆåŒæ­¥æŠ¥å‘Š
          cat > sync-report.md << 'EOF'
          ## è§†é¢‘æºåŒæ­¥æŠ¥å‘Š

          **æ‰§è¡Œæ—¶é—´:** ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}
          **å·¥ä½œæµ:** ${{ github.run_id }}

          ### åŒæ­¥ç»Ÿè®¡

          - æ€»æºæ•°: ${{ steps.sync.outputs.total || 'N/A' }}
          - å¥åº·æºæ•°: ${{ steps.sync.outputs.healthy || 'N/A' }}

          ### è¯¦ç»†æ—¥å¿—

          æŸ¥çœ‹é™„ä»¶ `sync-results` èŽ·å–å®Œæ•´çš„ sources.json å’ŒåŒæ­¥æ—¥å¿—ã€‚

          ---

          ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
          EOF

      - name: Comment on commit (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('sync-report.md', 'utf8');

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: report
            });

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ è§†é¢‘æºåŒæ­¥å¤±è´¥',
              body: `åŒæ­¥å·¥ä½œæµåœ¨ ${{ github.run_id }} ä¸­å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚`,
              labels: ['sync', 'automated', 'bug']
            });

  # å¯é€‰ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Pages
  deploy:
    name: Deploy to Cloudflare Pages
    needs: sync
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || github.event.inputs.environment == 'production')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download sync artifacts
        uses: actions/download-artifact@v4
        with:
          name: sync-results
          path: ./sync-results

      - name: Copy synced sources
        run: |
          if [ -f ./sync-results/sources.json ]; then
            cp ./sync-results/sources.json ./public/sources.json
            echo "Synced sources copied to public directory"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: false

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name=moontv --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
